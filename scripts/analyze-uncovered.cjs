// analyze-uncovered.cjs
// åˆ†ææœªè¦†ç›–çš„å…¬å‘Šï¼Œå¯»æ‰¾æ–°çš„åˆ†ç±»æ¨¡å¼

const Database = require('better-sqlite3');
const path = require('path');

const dbPath = path.join(process.env.HOME, 'Library/Application Support/cafe-stock/cafe_stock.db');
const db = new Database(dbPath, { readonly: true });

console.log('ğŸ” åˆ†ææœªè¦†ç›–çš„å…¬å‘Š...\n');

const sampleSize = 10000;
const samples = db.prepare(`
  SELECT title 
  FROM announcements 
  WHERE title IS NOT NULL AND title != ''
  ORDER BY RANDOM() 
  LIMIT ?
`).all(sampleSize);

// ç®€åŒ–çš„åˆ†ç±»å‡½æ•°ï¼ˆåªæ£€æŸ¥æ˜¯å¦è¢«è¦†ç›–ï¼‰
const allKeywords = [
	// è´¢åŠ¡æŠ¥å‘Š
	'å¹´åº¦æŠ¥å‘Š', 'å¹´æŠ¥', 'åŠå¹´åº¦æŠ¥å‘Š', 'åŠå¹´æŠ¥', 'å­£åº¦æŠ¥å‘Š', 'å­£æŠ¥', 'ä¸€å­£æŠ¥', 'ä¸‰å­£æŠ¥',
	'è´¢åŠ¡æŠ¥å‘Š', 'è´¢åŠ¡æŠ¥è¡¨', 'ä¸šç»©å¿«æŠ¥', 'ä¸šç»©é¢„å‘Š', 'ç›ˆåˆ©é¢„å‘Š', 'å®¡è®¡æŠ¥å‘Š', 'å®¡è®¡',
	'ä¼šè®¡', 'ä¼šè®¡å¸ˆäº‹åŠ¡æ‰€', 'ä¸šç»©è¯´æ˜ä¼š',
	// åˆ†çº¢æ´¾æ¯
	'åˆ†çº¢', 'æ´¾æ¯', 'ç°é‡‘åˆ†çº¢', 'é€è‚¡', 'è½¬å¢', 'åˆ©æ¶¦åˆ†é…', 'è‚¡åˆ©åˆ†é…', 'æƒç›Šåˆ†æ´¾', 'é™¤æƒé™¤æ¯',
	// è‚¡æƒå˜åŠ¨
	'è‚¡æƒå˜åŠ¨', 'æƒç›Šå˜åŠ¨', 'å¢æŒ', 'å‡æŒ', 'è‚¡ä»½å›è´­', 'å›è´­è‚¡ä»½', 'å›è´­',
	'é™å”®è‚¡', 'è§£ç¦', 'è‚¡æƒæ¿€åŠ±', 'å‘˜å·¥æŒè‚¡', 'å‡ºå”®è‚¡ä»½', 'å‡ºå”®å·²å›è´­',
	// é£é™©æç¤º
	'é£é™©æç¤º', 'é£é™©è­¦ç¤º', 'å¼‚å¸¸æ³¢åŠ¨', 'è‚¡ä»·å¼‚å¸¸', 'ST', '*ST', 'é€€å¸‚é£é™©', 'é€€å¸‚',
	'åœç‰Œ', 'å¤ç‰Œ', 'æ ¸æŸ¥', 'é—®è¯¢', 'é—®è¯¢å‡½', 'å…³æ³¨å‡½', 'å›å¤', 'å›å¤å‡½',
	'æ¾„æ¸…', 'æ¾„æ¸…å…¬å‘Š', 'èµ„äº§å‡å€¼', 'è®¡æå‡å€¼',
	// å…¬å¸æ²»ç†
	'è‘£äº‹ä¼š', 'è‘£äº‹ä¼šå†³è®®', 'ç›‘äº‹ä¼š', 'ç›‘äº‹ä¼šå†³è®®', 'è‚¡ä¸œå¤§ä¼š', 'è‚¡ä¸œä¼š', 'ä¸´æ—¶è‚¡ä¸œå¤§ä¼š',
	'ç‹¬ç«‹è‘£äº‹', 'è‘£äº‹', 'é«˜ç®¡', 'æ€»ç»ç†', 'å‰¯æ€»ç»ç†', 'è´¢åŠ¡æ€»ç›‘', 'è‘£äº‹é•¿', 'ç›‘äº‹',
	'ä»»å‘½', 'é€‰ä¸¾', 'è¾èŒ', 'ç¦»èŒ', 'è˜ä»»', 'ç« ç¨‹', 'ç« ç¨‹ä¿®è®¢',
	'ä¼šè®®é€šçŸ¥', 'ä¼šè®®å†³è®®', 'ä¼šè®®', 'æå', 'å€™é€‰äºº',
	// æ‹…ä¿
	'æ‹…ä¿', 'æä¾›æ‹…ä¿', 'åæ‹…ä¿', 'æ‹…ä¿é¢åº¦', 'å¯¹å¤–æ‹…ä¿',
	// äº¤æ˜“
	'å…³è”äº¤æ˜“', 'æ—¥å¸¸å…³è”äº¤æ˜“', 'è´­ä¹°èµ„äº§', 'å‡ºå”®èµ„äº§', 'èµ„äº§è½¬è®©', 'è‚¡æƒè½¬è®©', 'äº¤æ˜“', 'ä¹°å–',
	// é‡å¤§äº‹é¡¹
	'é‡å¤§äº‹é¡¹', 'é‡å¤§äº‹ä»¶', 'é‡å¤§èµ„äº§é‡ç»„', 'èµ„äº§é‡ç»„', 'æ”¶è´­', 'å…¼å¹¶', 'å¹¶è´­', 'é‡ç»„', 'æ•´åˆ', 'é‡å¤§åˆåŒ',
	// æŠ•èµ„
	'å¯¹å¤–æŠ•èµ„', 'æŠ•èµ„è®¾ç«‹', 'è®¾ç«‹', 'å‚è‚¡', 'æ§è‚¡', 'åˆèµ„', 'åˆä½œ', 'å­å…¬å¸', 'å…¨èµ„å­å…¬å¸', 'æŠ•èµ„è¿›å±•',
	// ç»è¥
	'ç»è¥æƒ…å†µ', 'ç”Ÿäº§ç»è¥', 'ç»è¥æ•°æ®', 'é¡¹ç›®', 'å·¥ç¨‹', 'ä¸­æ ‡', 'ä¸­æ ‡å…¬å‘Š',
	'åˆåŒ', 'ç­¾è®¢åˆåŒ', 'ç­¾ç½²', 'åè®®', 'å»ºè®¾', 'æ–½å·¥', 'å®Œæˆ', 'ç«£å·¥',
	'æˆä¿¡', 'ç»¼åˆæˆä¿¡', 'é“¶è¡Œæˆä¿¡',
	// å€ºåˆ¸
	'å€ºåˆ¸', 'å…¬å¸å€º', 'å¯è½¬å€º', 'è½¬å€º', 'å¯è½¬æ¢å€ºåˆ¸', 'ä»˜æ¯', 'å…‘ä»˜', 'æ‘˜ç‰Œ',
	'å‘è¡Œ', 'å‘è¡Œç»“æœ', 'ä¿¡ç”¨è¯„çº§', 'è¯„çº§', 'è½¬è‚¡',
	// å†…éƒ¨æ§åˆ¶
	'å†…éƒ¨æ§åˆ¶', 'å†…æ§', 'é‰´è¯æŠ¥å‘Š', 'è‡ªæˆ‘è¯„ä»·', 'ç®¡ç†åˆ¶åº¦', 'ä¿¡æ¯æŠ«éœ²',
	// èµ„è´¨
	'é«˜æ–°æŠ€æœ¯ä¼ä¸š', 'é«˜æ–°è®¤å®š', 'èµ„è´¨', 'è®¤è¯', 'è®¸å¯è¯', 'è¯ä¹¦', 'ä¸“åˆ©', 'çŸ¥è¯†äº§æƒ',
	// åŸºé‡‘
	'åŸºé‡‘', 'åŸºé‡‘ç®¡ç†', 'å¼€æ”¾æ—¥å¸¸', 'å¼€æ”¾ç”³è´­', 'å¼€æ”¾èµå›', 'åŸºé‡‘ä»½é¢', 'åŸºé‡‘å‡€å€¼', 'ä¼°å€¼è°ƒæ•´',
	// è¯‰è®¼
	'è¯‰è®¼', 'èµ·è¯‰', 'è¢«è¯‰', 'ä»²è£', 'çº çº·', 'æ³•å¾‹çº çº·', 'åˆ¤å†³', 'è£å†³', 'æ³•å¾‹'
];

function isCovered(title) {
	return allKeywords.some(kw => title.includes(kw));
}

// æ‰¾å‡ºæ‰€æœ‰æœªè¦†ç›–çš„å…¬å‘Š
const uncovered = samples.filter(s => !isCovered(s.title));

console.log(`æœªè¦†ç›–å…¬å‘Šæ•°é‡: ${uncovered.length} / ${sampleSize} (${((uncovered.length / sampleSize) * 100).toFixed(2)}%)\n`);

// åˆ†ææœªè¦†ç›–å…¬å‘Šä¸­çš„é«˜é¢‘è¯
console.log('ğŸ“Š æœªè¦†ç›–å…¬å‘Šä¸­çš„é«˜é¢‘å…³é”®è¯ï¼š\n');

// æå–å…³é”®è¯å€™é€‰
const potentialKeywords = [
	'æŠ•èµ„è€…å…³ç³»', 'æŠ•èµ„è€…', 'å…³ç³»æ´»åŠ¨',
	'æ¿€åŠ±', 'è‚¡ç¥¨æœŸæƒ', 'é™åˆ¶æ€§è‚¡ç¥¨', 'æœŸæƒ',
	'ç¨³å®šè‚¡ä»·', 'ç¨³å®š',
	'ç¦»å²—', 'é€€è´¹',
	'æ³¨é”€',
	'å‹Ÿé›†èµ„é‡‘', 'é—²ç½®å‹Ÿé›†èµ„é‡‘', 'ç°é‡‘ç®¡ç†',
	'æŒç»­ç£å¯¼', 'ç£å¯¼',
	'ç¯å¢ƒ', 'ç¤¾ä¼š', 'æ²»ç†', 'ESG', 'ç¤¾ä¼šè´£ä»»',
	'å¤–æ±‡', 'å¥—æœŸä¿å€¼',
	'è´¨æŠ¼', 'è§£é™¤è´¨æŠ¼',
	'æ³¨å†Œèµ„æœ¬', 'å˜æ›´æ³¨å†Œ',
	'è¡¥å……æµåŠ¨èµ„é‡‘',
	'é¢„å¢', 'ä¸šç»©é¢„å¢',
	'ç»†åˆ™', 'å·¥ä½œç»†åˆ™',
	'èµå›', 'åˆ°æœŸèµå›'
];

const keywordFreq = {};
potentialKeywords.forEach(kw => {
	const count = uncovered.filter(s => s.title.includes(kw)).length;
	if (count > 0) {
		keywordFreq[kw] = count;
	}
});

const sortedFreq = Object.entries(keywordFreq)
	.sort((a, b) => b[1] - a[1])
	.slice(0, 30);

console.log('å…³é”®è¯\t\t\tå‡ºç°æ¬¡æ•°\tè¦†ç›–ç‡');
console.log('â”€'.repeat(60));
sortedFreq.forEach(([kw, count]) => {
	const coverage = ((count / uncovered.length) * 100).toFixed(2);
	console.log(`${kw.padEnd(20)}\t${count}\t\t${coverage}%`);
});

// å»ºè®®æ–°å¢çš„åˆ†ç±»
console.log('\n\nğŸ’¡ å»ºè®®æ–°å¢çš„åˆ†ç±»ï¼š\n');

const suggestedCategories = [
	{
		name: 'æŠ•èµ„è€…å…³ç³»',
		keywords: ['æŠ•èµ„è€…å…³ç³»', 'æŠ•èµ„è€…å…³ç³»æ´»åŠ¨', 'æŠ•èµ„è€…å…³ç³»ç®¡ç†'],
		estimatedCoverage: keywordFreq['æŠ•èµ„è€…å…³ç³»'] || 0
	},
	{
		name: 'è‚¡æƒæ¿€åŠ±',
		keywords: ['è‚¡æƒæ¿€åŠ±', 'è‚¡ç¥¨æœŸæƒ', 'é™åˆ¶æ€§è‚¡ç¥¨', 'æœŸæƒæ¿€åŠ±', 'æ¿€åŠ±è®¡åˆ’', 'æ¿€åŠ±å¯¹è±¡'],
		estimatedCoverage: (keywordFreq['æ¿€åŠ±'] || 0) + (keywordFreq['è‚¡ç¥¨æœŸæƒ'] || 0) + (keywordFreq['é™åˆ¶æ€§è‚¡ç¥¨'] || 0)
	},
	{
		name: 'å‹Ÿé›†èµ„é‡‘',
		keywords: ['å‹Ÿé›†èµ„é‡‘', 'é—²ç½®å‹Ÿé›†èµ„é‡‘', 'ç°é‡‘ç®¡ç†', 'è¡¥å……æµåŠ¨èµ„é‡‘'],
		estimatedCoverage: (keywordFreq['å‹Ÿé›†èµ„é‡‘'] || 0) + (keywordFreq['é—²ç½®å‹Ÿé›†èµ„é‡‘'] || 0) + (keywordFreq['ç°é‡‘ç®¡ç†'] || 0)
	},
	{
		name: 'æŒç»­ç£å¯¼',
		keywords: ['æŒç»­ç£å¯¼', 'ç£å¯¼æŠ¥å‘Š', 'å®šæœŸç°åœºæ£€æŸ¥'],
		estimatedCoverage: keywordFreq['æŒç»­ç£å¯¼'] || 0
	},
	{
		name: 'ESGæŠ¥å‘Š',
		keywords: ['ESG', 'ç¤¾ä¼šè´£ä»»', 'å¯æŒç»­å‘å±•', 'ç¯å¢ƒæŠ¥å‘Š', 'æ²»ç†æŠ¥å‘Š'],
		estimatedCoverage: (keywordFreq['ESG'] || 0) + (keywordFreq['ç¤¾ä¼šè´£ä»»'] || 0)
	},
	{
		name: 'è‚¡ä»½è´¨æŠ¼',
		keywords: ['è´¨æŠ¼', 'è§£é™¤è´¨æŠ¼', 'è‚¡ä»½è´¨æŠ¼', 'å†è´¨æŠ¼'],
		estimatedCoverage: keywordFreq['è´¨æŠ¼'] || 0
	}
];

suggestedCategories.forEach(cat => {
	const coverage = ((cat.estimatedCoverage / uncovered.length) * 100).toFixed(2);
	console.log(`${cat.name.padEnd(12)}: é¢„è®¡è¦†ç›– ${cat.estimatedCoverage} æ¡ (${coverage}%)`);
	console.log(`  å…³é”®è¯: ${cat.keywords.join(', ')}`);
	console.log();
});

// æ˜¾ç¤ºä¸€äº›å…¸å‹çš„æœªè¦†ç›–æ ·æœ¬
console.log('\nğŸ“‹ å…¸å‹çš„æœªè¦†ç›–å…¬å‘Šæ ·æœ¬ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰ï¼š\n');

console.log('ã€æŠ•èµ„è€…å…³ç³»ç±»ã€‘');
uncovered.filter(s => s.title.includes('æŠ•èµ„è€…å…³ç³»')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

console.log('\nã€è‚¡æƒæ¿€åŠ±ç±»ã€‘');
uncovered.filter(s => s.title.includes('æ¿€åŠ±') || s.title.includes('æœŸæƒ')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

console.log('\nã€å‹Ÿé›†èµ„é‡‘ç±»ã€‘');
uncovered.filter(s => s.title.includes('å‹Ÿé›†èµ„é‡‘') || s.title.includes('ç°é‡‘ç®¡ç†')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

console.log('\nã€ESG/ç¤¾ä¼šè´£ä»»ç±»ã€‘');
uncovered.filter(s => s.title.includes('ESG') || s.title.includes('ç¤¾ä¼šè´£ä»»') || s.title.includes('å¯æŒç»­')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

console.log('\nã€æŒç»­ç£å¯¼ç±»ã€‘');
uncovered.filter(s => s.title.includes('æŒç»­ç£å¯¼') || s.title.includes('ç£å¯¼')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

console.log('\nã€è‚¡ä»½è´¨æŠ¼ç±»ã€‘');
uncovered.filter(s => s.title.includes('è´¨æŠ¼')).slice(0, 3).forEach(s => {
	console.log(`  - ${s.title}`);
});

db.close();
console.log('\nâœ¨ åˆ†æå®Œæˆï¼');

