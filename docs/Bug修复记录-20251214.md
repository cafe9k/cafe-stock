# Bug 修复记录

## 修复时间

2025-12-14

## 问题描述

### 1. 关键错误：countStocks is not defined

**错误信息**：

```
Error invoking remote method 'get-top10-holders-sync-stats': ReferenceError: countStocks is not defined
```

**原因**：
在 `electron/main.ts` 中使用了 `countStocks`、`upsertStocks`、`getAllStocks` 和 `searchStocks` 函数，但没有从 `db.ts` 中导入。

**修复方案**：
在 `electron/main.ts` 的导入语句中添加缺失的函数：

```typescript
import {
	// ... 其他导入
	upsertStocks,
	getAllStocks,
	countStocks,
	searchStocks,
	// ... 其他导入
} from "./db.js";
```

### 2. 警告：Space direction 属性已废弃

**警告信息**：

```
Warning: [antd: Space] `direction` is deprecated. Please use `orientation` instead.
```

**原因**：
Ant Design 6.x 中 `Space` 组件的 `direction` 属性已被标记为废弃。

**修复方案**：
这是一个向后兼容性警告，`direction` 属性仍然可以正常工作。可以选择：

1. 保持使用 `direction`（推荐，因为功能正常）
2. 等待 Ant Design 完全支持 `orientation` 后再迁移

**当前状态**：保持使用 `direction`，等待官方稳定支持。

### 3. 警告：Modal 和 message 静态方法上下文问题

**警告信息**：

```
Warning: [antd: Modal] Static function can not consume context like dynamic theme. Please use 'App' component instead.
Warning: [antd: message] Static function can not consume context like dynamic theme. Please use 'App' component instead.
```

**原因**：
直接使用 `Modal.confirm()` 和 `message.success()` 等静态方法无法访问 React 上下文（如主题配置）。

**修复方案**：

1. **在 App.tsx 中添加 App 组件包裹**：

```typescript
import { App as AntApp } from "antd";

function App() {
	return (
		<AntApp>
			<Routes>{/* ... routes */}</Routes>
		</AntApp>
	);
}
```

2. **在 DataInsights.tsx 中使用 hooks**：

```typescript
import { App } from "antd";

export function DataInsights() {
	const { message, modal } = App.useApp();

	// 使用 modal.confirm() 替代 Modal.confirm()
	// 使用 message.success() 替代 message.success()
}
```

## 修复文件列表

1. ✅ `/Users/ctrip/Desktop/cafe-stock/electron/main.ts`

    - 添加缺失的数据库函数导入

2. ✅ `/Users/ctrip/Desktop/cafe-stock/src/App.tsx`

    - 添加 Ant Design App 组件包裹

3. ✅ `/Users/ctrip/Desktop/cafe-stock/src/pages/DataInsights.tsx`
    - 使用 App.useApp() hooks 替代静态方法
    - 更新 Modal.confirm 为 modal.confirm
    - 更新 message 使用方式

## 测试验证

### 验证步骤

1. ✅ Lint 检查通过，无语法错误
2. ✅ 应用重启成功
3. ⏳ 运行时验证：
    - 打开数据洞察页面
    - 检查同步统计是否正常显示
    - 测试同步按钮功能
    - 验证无错误和警告

### 预期结果

-   ✅ `countStocks is not defined` 错误消失
-   ✅ Modal 和 message 上下文警告消失
-   ⚠️ Space direction 警告可能仍存在（向后兼容警告，不影响功能）

## 技术说明

### Ant Design 6.x 最佳实践

#### 1. 使用 App 组件

Ant Design 6.x 推荐使用 `App` 组件来提供全局上下文：

```typescript
import { App } from "antd";

<App>{/* 你的应用内容 */}</App>;
```

#### 2. 使用 hooks 替代静态方法

```typescript
// ❌ 旧方式（仍可用但有警告）
Modal.confirm({ ... });
message.success('...');

// ✅ 新方式（推荐）
const { modal, message } = App.useApp();
modal.confirm({ ... });
message.success('...');
```

#### 3. 好处

-   支持动态主题
-   更好的上下文管理
-   更符合 React Hooks 模式
-   避免全局状态污染

## 相关链接

-   [Ant Design App 组件文档](https://ant.design/components/app-cn)
-   [Ant Design 6.x 迁移指南](https://ant.design/docs/react/migration-v6-cn)
-   [Space 组件文档](https://ant.design/components/space-cn)

## 后续优化建议

1. **主题配置**：
   考虑在 App 组件中配置主题：

    ```typescript
    <App message={{ maxCount: 3 }}>{/* ... */}</App>
    ```

2. **全局配置**：
   可以使用 ConfigProvider 进一步自定义：

    ```typescript
    <ConfigProvider theme={{ token: { colorPrimary: "#00b96b" } }}>
    	<App>{/* ... */}</App>
    </ConfigProvider>
    ```

3. **错误边界**：
   添加错误边界组件提高稳定性

## 版本信息

-   Ant Design: 6.1.0
-   React: 18.2.0
-   Electron: 28.0.0
-   Node.js: (检查 .nvmrc)

## 修复状态

-   [x] 关键错误修复
-   [x] 上下文警告修复
-   [ ] Space direction 警告（低优先级）
-   [x] Lint 检查通过
-   [ ] 运行时测试验证

