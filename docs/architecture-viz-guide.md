# 架构可视化数据更新指南

## 📋 概述

本文档说明如何更新和管理项目的架构可视化数据。

## 🚀 快速使用

### 方式一：使用 npm 命令（推荐）

```bash
# 完整版（带统计和状态检查）
npm run update:viz

# 或使用简写
npm run viz
```

### 方式二：直接运行脚本

```bash
# 完整更新脚本
bash scripts/update-architecture-viz.sh

# 或者
./scripts/update-architecture-viz.sh
```

### 方式三：仅生成数据

```bash
# 只生成 cytoscape 数据文件
npm run generate:cytoscape

# 或者
node scripts/generate-cytoscape-data.cjs
```

## 📝 使用场景

### 何时需要更新架构可视化数据？

1. **添加新文件** - 创建新的 TS/TSX 文件后
2. **修改依赖** - 更新文件头部注释中的依赖信息后
3. **重构代码** - 移动或重命名文件后
4. **查看最新架构** - 需要查看当前项目结构时

### 工作流程示例

```bash
# 1. 修改文件，更新头部注释中的依赖信息
# 例如在 src/services/newService.ts 中添加：
# 依赖: types(类型定义) [../types/stock.ts]

# 2. 更新架构可视化数据
npm run viz

# 3. 查看效果
# 访问 http://localhost:5173 进入架构可视化页面
# 查看新生成的依赖关系边
```

## 🎯 文件头部注释格式

### 依赖字段格式

```typescript
/**
 * 依赖: 外部库描述 [项目内文件相对路径1, 相对路径2, ...]
 * 输出: 导出的内容
 * 职责: 文件职责描述
 */
```

### 示例

```typescript
/**
 * 依赖: window.electronAPI(IPC), types(类型定义) [../types/stock.ts, ./favoriteStockService.ts]
 * 输出: getAllStocks(), getStockById() - 股票数据服务
 * 职责: 渲染进程服务层，封装股票相关的IPC调用
 */
```

### 规则说明

- **外部依赖**：仅作描述，如 `Ant Design(UI组件)`
- **项目内依赖**：用方括号列出，使用相对路径
- **相对路径**：从当前文件出发，指向被依赖的文件
- **路径格式**：`[../types/stock.ts, ./helper.ts]`（用逗号分隔）

## 📊 输出说明

运行更新命令后，会显示以下信息：

```
==================================================
🔄 更新架构可视化数据
==================================================

📊 步骤 1/3: 生成依赖关系图数据...
✓ 生成完成！
  节点数: 108
  边数: 112
  输出文件: src/assets/cytoscape-data.json

📈 步骤 2/3: 统计数据...
  节点总数: 108
  边总数: 112
    - 层级关系边: 106
    - 依赖关系边: 6

🔍 步骤 3/3: 检查应用状态...
✅ 应用正在运行，页面将自动刷新

💡 提示: 访问 http://localhost:5173 查看架构可视化页面

==================================================
✨ 架构可视化数据更新完成！
==================================================
```

## 🎨 可视化说明

### 节点类型

- **根节点**（橙色）：electron / src
- **目录**（绿色）：各级目录
- **文件**（蓝色）：TS/TSX 文件

### 边类型

- **实线箭头**（灰色）：父子包含关系
- **虚线箭头**（蓝色）：文件间依赖关系

## 🛠️ 故障排查

### 问题：依赖边没有生成

**可能原因**：
1. 文件头部注释格式不正确
2. 依赖路径写错
3. 依赖的目标文件不存在

**解决方法**：
```bash
# 运行更新命令查看警告信息
npm run viz

# 检查输出中的 "⚠️ 依赖目标不存在" 警告
# 修正路径后重新运行
```

### 问题：页面没有自动刷新

**解决方法**：
```bash
# 手动刷新浏览器
# 或者重启开发服务器
npm run dev
```

## 📚 相关文件

- **生成脚本**：`scripts/generate-cytoscape-data.cjs`
- **更新脚本**：`scripts/update-architecture-viz.sh`
- **数据文件**：`src/assets/cytoscape-data.json`
- **可视化页面**：`src/pages/ArchitectureVisualization.tsx`
- **规范文档**：`.cursor/rules/react-typescript.mdc`

## 💡 最佳实践

1. **及时更新**：每次修改文件依赖后运行 `npm run viz`
2. **完整标注**：尽量为所有文件添加依赖路径标注
3. **使用相对路径**：确保路径正确，从当前文件出发
4. **定期检查**：定期查看可视化页面，了解项目架构
5. **提交前生成**：提交代码前运行一次，确保数据是最新的

## 🔗 相关命令

```bash
# 启动开发服务器（会自动生成数据）
npm run dev

# 构建前自动生成数据
npm run build

# 仅生成数据
npm run generate:cytoscape

# 完整更新（推荐）
npm run viz
```

