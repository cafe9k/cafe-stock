# 十大股东功能说明

## 功能概述

在数据洞察页面新增了十大股东数据同步和查询功能，支持：

1. **批量同步**：循环拉取所有大 A 股票的十大股东数据
2. **单股同步**：针对每个股票手动同步最新信息
3. **数据库存储**：建立股东数据表，避免重复拉取
4. **搜索查询**：通过股票代码或名称搜索并查看十大股东

## 数据库设计

### 新增表：`top10_holders`

```sql
CREATE TABLE top10_holders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ts_code TEXT NOT NULL,              -- 股票代码
  ann_date TEXT NOT NULL,             -- 公告日期
  end_date TEXT NOT NULL,             -- 报告期
  holder_name TEXT NOT NULL,          -- 股东名称
  hold_amount REAL,                   -- 持股数量（股）
  hold_ratio REAL,                    -- 持股比例（%）
  updated_at TEXT NOT NULL,           -- 更新时间
  UNIQUE(ts_code, end_date, holder_name)  -- 唯一约束
);
```

### 索引

-   `idx_top10_ts_code`: 股票代码索引
-   `idx_top10_end_date`: 报告期索引
-   `idx_top10_holder_name`: 股东名称索引
-   `idx_top10_ts_end_date`: 股票代码+报告期组合索引

## API 接口

### Electron IPC 接口

#### 1. 搜索股票

```typescript
window.electronAPI.searchStocks(keyword: string, limit?: number)
```

-   **参数**：
    -   `keyword`: 搜索关键词（股票代码、名称或拼音）
    -   `limit`: 返回结果数量限制，默认 50
-   **返回**：股票列表

#### 2. 同步所有股票的十大股东

```typescript
window.electronAPI.syncAllTop10Holders();
```

-   **功能**：循环拉取所有大 A 股票的十大股东数据
-   **特点**：
    -   已同步的股票自动跳过
    -   实时显示同步进度
    -   API 限流保护（每次请求间隔 200ms）
-   **返回**：同步结果统计

#### 3. 同步单个股票的十大股东

```typescript
window.electronAPI.syncStockTop10Holders(tsCode: string)
```

-   **参数**：
    -   `tsCode`: 股票代码
-   **功能**：手动更新指定股票的十大股东数据
-   **特点**：删除旧数据后重新拉取最新数据

#### 4. 从数据库获取十大股东数据

```typescript
window.electronAPI.getTop10HoldersFromDb(tsCode: string, limit?: number)
```

-   **参数**：
    -   `tsCode`: 股票代码
    -   `limit`: 返回结果数量限制，默认 100
-   **返回**：十大股东列表（从本地数据库）

#### 5. 从 API 获取十大股东数据

```typescript
window.electronAPI.getTop10Holders(tsCode: string, period?: string, annDate?: string, startDate?: string, endDate?: string)
```

-   **参数**：
    -   `tsCode`: 股票代码
    -   `period`: 报告期（可选）
    -   `annDate`: 公告日期（可选）
    -   `startDate`: 开始日期（可选）
    -   `endDate`: 结束日期（可选）
-   **返回**：十大股东列表（从 Tushare API）

#### 6. 检查是否已有数据

```typescript
window.electronAPI.hasTop10HoldersData(tsCode: string)
```

-   **参数**：
    -   `tsCode`: 股票代码
-   **返回**：布尔值，表示数据库中是否存在该股票的十大股东数据

#### 7. 获取同步统计信息

```typescript
window.electronAPI.getTop10HoldersSyncStats();
```

-   **返回**：
    -   `totalStocks`: 股票总数
    -   `syncedStocks`: 已同步股票数
    -   `syncedStockCodes`: 已同步股票代码列表
    -   `syncRate`: 同步进度百分比

#### 8. 监听同步进度

```typescript
window.electronAPI.onTop10HoldersSyncProgress(callback: (progress: SyncProgress) => void)
```

-   **参数**：
    -   `callback`: 进度回调函数
-   **进度对象**：
    ```typescript
    {
      current: number;           // 当前进度
      total: number;             // 总数
      tsCode: string;            // 当前股票代码
      name: string;              // 当前股票名称
      status: "success" | "skipped" | "failed";  // 状态
      error?: string;            // 错误信息（如果失败）
      successCount: number;      // 成功数量
      skipCount: number;         // 跳过数量
      failCount: number;         // 失败数量
    }
    ```

## 使用指南

### 1. 首次使用

首次启动应用时，会自动同步股票列表（如果数据库为空）。

### 2. 批量同步十大股东

1. 打开"数据洞察"页面
2. 点击"同步所有股票十大股东"按钮
3. 确认同步操作
4. 等待同步完成（会显示实时进度）

**注意事项**：

-   首次同步约需 1-2 小时（取决于网络和 API 限流）
-   已同步的股票会自动跳过
-   同步过程中可关闭进度弹窗，后台继续执行
-   API 限流时会自动延迟重试

### 3. 查询股票的十大股东

1. 在搜索框输入股票代码或名称
2. 从下拉列表选择股票
3. 系统会优先从数据库加载数据
4. 如果数据库没有数据，会从 API 实时拉取

### 4. 手动更新单个股票

1. 选择要更新的股票
2. 点击"更新数据"或"同步数据"按钮
3. 等待更新完成

**说明**：

-   "同步数据"：首次拉取数据时显示
-   "更新数据"：已有数据时显示，会删除旧数据后重新拉取

## 数据说明

### 十大股东数据来源

数据来自 Tushare Pro API 的 `top10_holders` 接口：

-   接口文档：https://tushare.pro/document/2?doc_id=61
-   权限要求：至少 2000 积分
-   数据更新：按公告日期更新

### 数据字段

| 字段名      | 说明           | 示例                 |
| ----------- | -------------- | -------------------- |
| ts_code     | 股票代码       | 000001.SZ            |
| holder_name | 股东名称       | 香港中央结算有限公司 |
| hold_amount | 持股数量（股） | 1234567890           |
| hold_ratio  | 持股比例（%）  | 5.23                 |
| end_date    | 报告期         | 20231231             |
| ann_date    | 公告日期       | 20240115             |

## 性能优化

### 1. 数据库索引

已建立多个索引加速查询：

-   股票代码索引：快速查询指定股票的股东
-   报告期索引：按时间排序
-   股东名称索引：支持股东持股分析

### 2. API 限流控制

-   请求间隔：200ms/次
-   限流检测：自动延迟 5 秒重试
-   批量同步：自动跳过已有数据

### 3. 数据去重

使用唯一约束 `(ts_code, end_date, holder_name)` 避免重复数据。

## 未来扩展

### 1. 股东持股分析

可基于已有数据实现：

-   股东持股变化趋势
-   股东持股多只股票分析
-   机构股东持仓分析

### 2. 数据可视化

可添加：

-   持股比例饼图
-   持股数量变化趋势图
-   股东持仓分布图

### 3. 导出功能

支持导出：

-   单只股票的十大股东数据
-   特定股东的持仓列表
-   批量导出 Excel

## 常见问题

### Q1: 同步失败怎么办？

**A**: 可能的原因：

1. API 积分不足（需要至少 2000 积分）
2. 网络连接问题
3. API 限流

**解决方法**：

-   检查 Tushare Pro 账号积分
-   检查网络连接
-   等待后重试

### Q2: 同步很慢怎么办？

**A**: 这是正常现象，因为：

1. API 有限流保护（每次请求间隔 200ms）
2. 数据量较大（5000+ 只股票）
3. 网络延迟

**建议**：

-   首次同步选择空闲时间进行
-   同步可在后台运行
-   已同步的股票不会重复拉取

### Q3: 如何更新数据？

**A**: 两种方式：

1. **单股更新**：选择股票后点击"更新数据"按钮
2. **批量更新**：清空数据库后重新同步（暂未实现清空功能）

### Q4: 数据存储在哪里？

**A**: 数据存储在本地 SQLite 数据库：

-   路径：`~/Library/Application Support/酷咖啡/cafe_stock.db` (macOS)
-   表名：`top10_holders`

## 技术架构

```
┌─────────────────┐
│  DataInsights   │  前端界面（React + Ant Design）
│     页面        │
└────────┬────────┘
         │
         │ IPC 通信
         │
┌────────▼────────┐
│   Main Process  │  主进程（Electron）
│   (main.ts)     │  - 同步逻辑
│                 │  - API 调用
│                 │  - 进度通知
└────────┬────────┘
         │
         │ 数据库操作
         │
┌────────▼────────┐
│   Database      │  SQLite 数据库（better-sqlite3）
│   (db.ts)       │  - 数据存储
│                 │  - CRUD 操作
└────────┬────────┘
         │
         │ API 调用
         │
┌────────▼────────┐
│  Tushare API    │  Tushare Pro API
│  (tushare.ts)   │  - top10_holders 接口
│                 │  - stock_basic 接口
└─────────────────┘
```

## 代码文件

### 后端（Electron 主进程）

1. **electron/db.ts**

    - 数据库表结构
    - CRUD 操作函数

2. **electron/main.ts**

    - IPC 处理函数
    - 同步逻辑
    - 进度通知

3. **electron/preload.ts**

    - API 暴露

4. **electron/tushare.ts**
    - Tushare API 封装

### 前端（React 渲染进程）

1. **src/pages/DataInsights.tsx**

    - 数据洞察页面
    - 同步按钮
    - 进度显示
    - 股票查询

2. **src/electron.d.ts**
    - TypeScript 类型定义

## 版本历史

### v1.0.0 (2025-12-14)

-   ✅ 新增十大股东数据表
-   ✅ 实现批量同步功能
-   ✅ 实现单股同步功能
-   ✅ 添加股票搜索功能
-   ✅ 显示同步进度
-   ✅ 同步统计信息
-   ✅ 数据库去重
-   ✅ API 限流保护
